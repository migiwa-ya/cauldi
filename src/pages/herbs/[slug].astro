---
import type { APIContext } from "astro";
import type { Herb } from "../../types/herbs";
import db from "../../../staticql.config.ts";
import { formatDate } from "../../utils/date";

export async function getStaticPaths() {
  const herbs: Herb[] = await db
    .from("herbs")
    .join("reports")
    .join("tags")
    .options({ indexMode: "only" })
    .exec();

  return await Promise.all(
    herbs.map(async (herb) => {
      herb.description = yamlContentSplitSection(herb.content);

      if (herb.reports) {
        for await (const report of herb.reports) {
          if (!report.reportGroupSlug) {
            herb.reports = [];
            continue;
          }

          const reportGroups: ReportGroup[] = await db
            .from("reportGroups")
            .where("slug", "eq", report.reportGroupSlug)
            .options({ indexMode: "only" })
            .exec();

          const processes = await db
            .from("processes")
            .where("slug", "eq", reportGroups[0].processSlug)
            .options({ indexMode: "only" })
            .exec();

          report.process = processes[0];
        }
      }

      return {
        params: { slug: herb.slug },
        props: { herb },
      };
    })
  );
}

export function GET({ props }: APIContext) {
  return new Response(JSON.stringify({ herb: props.herb }));
}

const { herb }: { herb: Herb } = Astro.props;

import Layout from "../../layouts/Layout.astro";
import HerbImages from "../../components/HerbImages.tsx";
import HerbCompounds from "../../components/HerbCompounds.tsx";
import ImageModal from "../../components/ImageModal";
import ColumnUnit from "../../components/ColumnUnit";
import { yamlContentSplitSection } from "../../utils/herbs";
import type { ReportGroup } from "../../types/reports";
import { undefined } from "astro:schema";
---

<Layout>
  <style>
    .herb-decoration {
      position: relative;
      background-color: var(--color-vintage-paper);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      overflow: hidden;

      &::before,
      &::after {
        position: absolute;
        content: "";
        height: 100%;
        top: 0;
        bottom: 0;
        margin: auto;
      }

      &::before {
        left: 0;
        border-left: 1px solid #000;
      }

      &::after {
        right: 0;
        border-right: 1px solid #000;
      }

      > div:first-child,
      > div:last-child {
        position: relative;
        width: 100%;
        height: 5px;
        background-color: var(--color-vintage-paper);
        z-index: 2;
      }
      > div:first-child {
        border-top: 2px solid #000;
      }
      > div:last-child {
        border-bottom: 2px solid #000;
      }

      > div:first-child::before,
      > div:first-child::after,
      > div:last-child::before,
      > div:last-child::after {
        content: "";
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: var(--color-vintage-paper);
        border-radius: 80%;
        border: 1px solid var(--color-vintage-ink);
      }

      > div:first-child::before {
        top: -30px;
        left: -30px;
      }

      > div:first-child::after {
        top: -30px;
        right: -30px;
      }

      > div:last-child::before {
        bottom: -30px;
        left: -30px;
      }

      > div:last-child::after {
        bottom: -30px;
        right: -30px;
      }
    }
  </style>
  <div class="flex justify-center border-b-1">
    <div class="c-content my-1 text-center border-x border-vintage-ink">
      <nav class="text-xs text-gray-600" aria-label="パンくずリスト">
        <ol class="flex flex-wrap items-center justify-center">
          <li>
            <a href="/" class="underline text-link">Home</a>
          </li>
          <li class="before:content-['›'] before:mx-2 before:text-gray-400">
            <a href="/natural-therapy/herbs" class="underline text-link"
              >Herbs</a
            >
          </li>
          <li
            class="before:content-['›'] before:mx-2 before:text-gray-400"
            aria-current="page"
          >
            {herb.nameScientific}
          </li>
        </ol>
      </nav>
      <h1 class="font-bold">
        {herb.name} ({herb.nameScientific})とは
      </h1>
    </div>
  </div>
  <div class="c-content p-7 my-1 space-y-5 border-x border-vintage-ink">
    <div class="herb-decoration mb-3">
      <div class="border-b border-dashed"></div>
      <div class="flex items-center mb-4 max-md:flex-col">
        <div
          class="border-r w-full font-serif my-[3px] p-6 max-md:border-0! max-md:border-b-1!"
        >
          <h2 class="block mb-1 text-center font-bold">{herb.name}の概要</h2>
          <p>{herb.overview}</p>
        </div>
        <img
          src="/ui/001.png"
          alt="aaa"
          width="400"
          height="300"
          class="w-full my-[3px] p-6 object-contain h-[300px]"
          style="filter: contrast(150%) sepia(100%);"
        />
        <div
          class="border-l w-full font-serif my-[3px] p-6 max-md:border-0! max-md:border-t-1!"
        >
          <h2 class="block mb-1 text-center font-bold">
            {herb.name}の期待される効果・効能
          </h2>
          <p>{herb.efficacy}</p>
        </div>
      </div>
      <div class="border-t border-dashed"></div>
    </div>

    <aside class="report-links">
      {
        herb.reports &&
          herb.reports.map((report) => (
            <a
              href={`/reports/${report.reportGroupSlug}`}
              class="report-link-card"
            >
              <div>
                <div>
                  <time datetime={formatDate(report.updatedAt)}>
                    {formatDate(report.updatedAt, "Y/m/d")}
                  </time>
                  <p class="w-32 line-clamp-1">
                    ({report.ingredients?.join("・")})
                  </p>
                </div>
                <div>
                  <p>{report.process?.name}</p>
                  <p>{report.summary}</p>
                </div>
              </div>
              <img src="/ui/001.png" alt="" />
            </a>
          ))
      }
    </aside>

    <article>
      <div
        class="flex flex-col sm:flex-row justify-between border-b-2 pb-2 mt-12 mb-4"
      >
        <span
          class="mr-2 text-[2.5rem] sm:text-[3rem] leading-[3rem] font-[Stoke] font-thin"
          >About</span
        >
        <p class="line-clamp-1 self-end font-[Stoke] text-sm">
          Pub. <time datetime={formatDate(herb.createdAt)}
            >{formatDate(herb.createdAt, "Y/m/d")}</time
          >
          Upd. <time datetime={formatDate(herb.updatedAt)}
            >{formatDate(herb.updatedAt, "Y/m/d")}</time
          >
        </p>
      </div>

      <div class="min-md:columns-2 [column-gap:2rem]">
        <section>
          <ImageModal
            imageUrl="/001.png"
            altText="ランダム画像3"
            className="w-full max-h-[300px] object-cover mb-2"
            client:only
          />
        </section>
        <section class="clear-both">
          {
            herb.description &&
              herb.description.map((desc) => <ColumnUnit {...desc} />)
          }
        </section>
        <section class="clear-both">
          <div class="c-column-head">
            <span class="font-[Stoke]">Tags</span>
            <h3 class="text-xs italic">
              {herb.name} ({herb.nameScientific})の特徴タグ
            </h3>
          </div>
          <div class="c-column-body flex gap-3">
            {
              herb.tags &&
                herb.tags.map((tag) => (
                  <a href={`/tags/${tag.slug}`} class="c-footer-tag">
                    <span class="font-bold">{tag.name}</span>
                  </a>
                ))
            }
          </div>
        </section>

        <!-- <section>
          <h3 class="c-column-head">Images</h3>
          <div class="c-column-body">
            <HerbImages images={herb.images} />
          </div>
        </section> -->
        <!-- <section>
          <h3 class="c-column-head">Compunds</h3>
          <div class="c-column-body">
            <HerbCompounds compounds={herb.compounds} />
          </div>
        </section> -->
        <section>
          <h3 class="c-column-head">Reserches</h3>
          <p class="c-column-body">
            {herb.researchPapers}
            <a
              href="http://"
              target="_blank"
              rel="noopener noreferrer"
              class="c-external-link">test</a
            >
          </p>
        </section>
      </div>
    </article>

    <section>
      <div
        class="flex flex-col sm:flex-row justify-between border-b-2 pb-2 mt-12 mb-4"
      >
        <span
          class="mr-2 text-[2.5rem] sm:text-[3rem] leading-[3rem] font-[Stoke] font-thin"
          >Other Herbs</span
        >
      </div>

      <aside class="flex flex-wrap justify-items-start gap-4 mb-12">
        <a
          class="herb-decoration relative flex flex-1 basis-auto sm:max-w-xs w-[200px]"
        >
          <div></div>
          <div class="relative max-md:flex-col">
            <div class="flex flex-col justify-center px-6">
              <span class="text-center border-b border-dashed pb-1 font-[Stoke]"
                >Rumex crispus</span
              >
              <p class="text-sm leading-5 py-3">
                タデ科ギシギシ属の多年草で、ヨーロッパ原産だが世界各地に分布。葉は細長く波打ち、根は黄色を帯びる。湿地や道端に自生し、耐久性が高い。根は生薬「羊蹄根（ようていこん）」として下剤や皮膚病治療に用いられるほか、葉は若いものが食用となる。
              </p>
            </div>
            <img
              src="/ui/001.png"
              alt="aaa"
              width="400"
              height="300"
              class="absolute inset-0 opacity-20 w-full h-full object-contain w-16 h-16 ml-1 rounded-e-xs"
              style="filter: contrast(150%) sepia(100%);"
            />
          </div>
          <div></div>
        </a>
        <a
          class="herb-decoration relative flex flex-1 basis-auto sm:max-w-xs w-[200px]"
        >
          <div></div>
          <div class="relative max-md:flex-col">
            <div class="flex flex-col justify-center px-6">
              <strong class="text-center border-b border-dashed pb-1"
                >Rumex crispus</strong
              >
              <p class="text-sm leading-5 py-3">
                タデ科ギシギシ属の多年草で、ヨーロッパ原産だが世界各地に分布。葉は細長く波打ち、根は黄色を帯びる。湿地や道端に自生し、耐久性が高い。根は生薬「羊蹄根（ようていこん）」として下剤や皮膚病治療に用いられるほか、葉は若いものが食用となる。
              </p>
            </div>
            <img
              src="/ui/001.png"
              alt="aaa"
              width="400"
              height="300"
              class="absolute inset-0 opacity-20 object-contain w-16 h-16 ml-1 rounded-e-xs"
              style="filter: contrast(150%) sepia(100%);"
            />
          </div>
          <div></div>
        </a>
        <a
          class="herb-decoration relative flex flex-1 basis-auto sm:max-w-xs w-[200px]"
        >
          <div></div>
          <div class="relative max-md:flex-col">
            <div class="flex flex-col justify-center px-6">
              <strong class="text-center border-b border-dashed pb-1"
                >Rumex crispus</strong
              >
              <p class="text-sm leading-5 py-3">
                タデ科ギシギシ属の多年草で、ヨーロッパ原産だが世界各地に分布。葉は細長く波打ち、根は黄色を帯びる。湿地や道端に自生し、耐久性が高い。根は生薬「羊蹄根（ようていこん）」として下剤や皮膚病治療に用いられるほか、葉は若いものが食用となる。
              </p>
            </div>
            <img
              src="/ui/001.png"
              alt="aaa"
              width="400"
              height="300"
              class="absolute inset-0 opacity-20 w-full h-full object-contain w-16 h-16 ml-1 rounded-e-xs"
              style="filter: contrast(150%) sepia(100%);"
            />
          </div>
          <div></div>
        </a>
      </aside>
    </section>
  </div>
</Layout>
